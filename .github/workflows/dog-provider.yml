name: '[Workflow] - Dog provider (bidirectional)'

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to. Select 'none' for build only."
        required: true
        type: choice
        default: 'none'
        options: [ none, test, production ]

env:
  MAVEN_CLI_OPTS: >
    --batch-mode --errors --fail-at-end --show-version
    -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn

jobs:
  build:
    name: Build & Generate OpenAPI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with: { distribution: 'temurin', java-version: '21', cache: 'maven' }
      - run: mvn -f dog-provider/pom.xml $MAVEN_CLI_OPTS clean install
      - uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: dog-provider/target/openapi.yaml
      - run: echo "OpenAPI specification generated by code" > verification-results.txt
      - uses: actions/upload-artifact@v4
        with:
          name: verification-results
          path: verification-results.txt

  publish_and_deploy:
    name: Publish & Deploy
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4
      - name: Setup Pact CLI
        uses: ./.github/actions/pact-cli-setup

      - name: Publish OpenAPI Specification
        uses: ./.github/actions/publish-openapi
        with:
          pact_broker_base_url: ${{ vars.PACT_BROKER_BASE_URL }}
          provider_name: 'dog-provider'
          provider_version: ${{ github.sha }}
          branch_name: ${{ github.ref_name }}
          openapi_artifact_name: 'openapi-spec'
          openapi_file_path: 'openapi.yaml'
          verification_artifact_name: 'verification-results'
          verification_file_path: 'verification-results.txt'
          pact_broker_token: ${{ secrets.PACTFLOW_TOKEN }}

      - name: Can I Deploy?
        if: github.event.inputs.environment != 'none'
        uses: ./.github/actions/can-i-deploy
        with:
          pact_broker_base_url: ${{ vars.PACT_BROKER_BASE_URL }}
          pacticipant: 'dog-provider'
          version: ${{ github.sha }}
          environment: ${{ github.event.inputs.environment }}
          pact_broker_token: ${{ secrets.PACTFLOW_TOKEN }}

      - name: Deploy
        if: github.event.inputs.environment != 'none'
        uses: ./.github/actions/deploy
        with:
          pacticipant: 'dog-provider'
          version: ${{ github.sha }}
          environment: ${{ github.event.inputs.environment }}

      - name: Tag Deployment
        if: github.event.inputs.environment != 'none'
        uses: ./.github/actions/tagging
        with:
          pact_broker_base_url: ${{ vars.PACT_BROKER_BASE_URL }}
          pacticipant: 'dog-provider'
          version: ${{ github.sha }}
          environment: ${{ github.event.inputs.environment }}
          pact_broker_token: ${{ secrets.PACTFLOW_TOKEN }}